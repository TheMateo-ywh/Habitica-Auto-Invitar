name: Habitica Party Bot - 6 Ciclos por Ejecuci√≥n

on:
  schedule:
    # Ejecuta cada 30 minutos, todo el d√≠a, todos los d√≠as.
    # Formato: minuto hora d√≠a-del-mes mes d√≠a-de-la-semana
    - cron: '*/30 * * * *'
  
  # Para ejecutar manualmente
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no real invites)'
        required: false
        type: boolean
        default: false

jobs:
  run-habitica-bot:
    runs-on: ubuntu-latest
    # Aumentamos el timeout porque cada ejecuci√≥n durar√° ~28 minutos
    timeout-minutes: 40
    
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      
      - name: Verificar estructura
        run: |
          echo "üìÖ Horario programado: Cada 30 minutos, continuo."
          echo "üîÑ Frecuencia: 48 ejecuciones/d√≠a (cada 30 min)"
          echo "‚öôÔ∏è  Configuraci√≥n interna: 6 ciclos con 5 min de intervalo"
          echo "‚è±Ô∏è  Duraci√≥n estimada por job: ~28-30 minutos"
          echo ""
          echo "üìÅ Verificando estructura..."
          if [ ! -f "main.go" ]; then
            echo "‚ùå ERROR: main.go no encontrado"
            exit 1
          fi
          echo "‚úÖ Estructura correcta"
      
      - name: Inicializar m√≥dulo Go si no existe
        run: |
          if [ ! -f go.mod ]; then
            echo "üì¶ Creando go.mod..."
            go mod init habitica-party-up
          fi
      
      - name: Descargar dependencias
        run: |
          echo "üì• Descargando dependencias..."
          go mod tidy
          echo "‚úÖ Dependencias listas"
      
      - name: Compilar programa
        run: |
          echo "üî® Compilando..."
          CGO_ENABLED=0 go build -o habitica-bot .
          echo "‚úÖ Compilado: $(du -h habitica-bot | cut -f1)"
      
      - name: Ejecutar bot (6 ciclos con intervalo)
        env:
          HABITICA_API_USER: ${{ secrets.HABITICA_API_USER }}
          HABITICA_API_KEY: ${{ secrets.HABITICA_API_KEY }}
          # Configuraci√≥n del bot
          MIN_LVL: 30
          LANGUAGE: ""
          ONLY_ACTIVE: "true"
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "üöÄ INICIANDO EJECUCI√ìN CON M√öLTIPLES CICLOS"
          echo "======================"
          echo "üïê Hora UTC: $(date -u '+%H:%M:%S')"
          echo "üìÖ Fecha: $(date -u '+%Y-%m-%d')"
          echo "üîÑ Configuraci√≥n: 6 ciclos, intervalo de 300 segundos (5 min)"
          echo "‚è±Ô∏è  Duraci√≥n total estimada: ~1680 segundos (28 min)"
          
          # Verificar credenciales
          if [ -z "$HABITICA_API_USER" ] || [ -z "$HABITICA_API_KEY" ]; then
            echo "‚ùå ERROR: Faltan credenciales"
            echo "Configura los secrets HABITICA_API_USER y HABITICA_API_KEY"
            exit 1
          fi
          
          echo "üë§ API User: ${HABITICA_API_USER:0:12}..."
          echo "‚öôÔ∏è  Config: min-lvl=$MIN_LVL, lang=$LANGUAGE, active-only=$ONLY_ACTIVE"
          
          # Ejecutar bot
          echo ""
          echo "‚ñ∂Ô∏è  Ejecutando Habitica Bot con 6 ciclos..."
          echo "--------------------------------------------------"
          
          START_TIME=$(date +%s)
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "‚ö†Ô∏è  MODO DRY RUN - No se enviar√°n invitaciones reales"
            # Valores FIJOS directamente en los flags
            ./habitica-bot \
              -api-user "$HABITICA_API_USER" \
              -api-key "$HABITICA_API_KEY" \
              -min-lvl "$MIN_LVL" \
              -language "$LANGUAGE" \
              -only-active "$ONLY_ACTIVE" \
              -max-cycles 6 \
              -fetch-interval 300
          else
            # Valores FIJOS directamente en los flags
            ./habitica-bot \
              -api-user "$HABITICA_API_USER" \
              -api-key "$HABITICA_API_KEY" \
              -min-lvl "$MIN_LVL" \
              -language "$LANGUAGE" \
              -only-active "$ONLY_ACTIVE" \
              -max-cycles 6 \
              -fetch-interval 300
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "‚úÖ EJECUCI√ìN COMPLETADA"
          echo "======================="
          echo "‚è±Ô∏è  Duraci√≥n total: ${DURATION} segundos"
          echo "üîÑ Pr√≥xima ejecuci√≥n autom√°tica: en 30 minutos"
          echo "üìÖ Horario programado: Cada 30 minutos (24/7)"
      
      - name: Limpiar
        if: always()
        run: |
          rm -f habitica-bot
          echo "üßπ Binario eliminado"