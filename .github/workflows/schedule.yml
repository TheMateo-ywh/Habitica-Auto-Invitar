name: Habitica Party Bot - Scheduled

on:
  schedule:
    # Se ejecuta cada 10 minutos durante la hora 9 (UTC)
    # 9:00, 9:10, 9:20, 9:30, 9:40, 9:50
    - cron: '0,10,20,30,40,50 9 * * *'
  
  # Para ejecutar manualmente desde la interfaz de GitHub
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (dry run)'
        required: false
        type: boolean
        default: false

jobs:
  run-habitica-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # M√°ximo 5 minutos por ejecuci√≥n
    
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      
      - name: Verificar estructura del proyecto
        run: |
          echo "üìÅ Contenido del directorio:"
          ls -la
          echo ""
          echo "üîç Verificando main.go..."
          if [ -f "main.go" ]; then
            echo "‚úÖ main.go encontrado"
            echo "üìÑ Primeras l√≠neas de main.go:"
            head -5 main.go
          else
            echo "‚ùå main.go NO encontrado"
            exit 1
          fi
      
      - name: Inicializar m√≥dulo Go (si no existe)
        run: |
          if [ ! -f go.mod ]; then
            echo "üì¶ Inicializando m√≥dulo Go..."
            go mod init habitica-party-up
          fi
      
      - name: Descargar dependencias
        run: |
          echo "üì• Descargando dependencias..."
          go mod tidy
          echo "‚úÖ Dependencias descargadas"
      
      - name: Compilar programa
        run: |
          echo "üî® Compilando programa..."
          go build -o habitica-bot .
          echo "‚úÖ Programa compilado"
          ls -lh habitica-bot
      
      - name: Ejecutar bot (un solo ciclo)
        env:
          HABITICA_API_USER: ${{ secrets.HABITICA_API_USER }}
          HABITICA_API_KEY: ${{ secrets.HABITICA_API_KEY }}
          # Configuraci√≥n del bot
          MIN_LVL: 50
          LANGUAGE: "en"
          ONLY_ACTIVE: "true"
          FETCH_INTERVAL: "120"
        run: |
          echo "üöÄ Iniciando Habitica Bot..."
          echo "üïê Fecha y hora: $(date)"
          echo "üë§ API User (primeros 8 chars): ${HABITICA_API_USER:0:8}..."
          echo "‚öôÔ∏è Configuraci√≥n:"
          echo "  - Nivel m√≠nimo: $MIN_LVL"
          echo "  - Idioma: $LANGUAGE"
          echo "  - Solo activos: $ONLY_ACTIVE"
          
          # Verificar que las credenciales existen
          if [ -z "$HABITICA_API_USER" ] || [ -z "$HABITICA_API_KEY" ]; then
            echo "‚ùå ERROR: Credenciales no configuradas"
            echo "Por favor, configura los secrets HABITICA_API_USER y HABITICA_API_KEY"
            exit 1
          fi
          
          # Ejecutar el bot en modo single-run
          echo ""
          echo "‚ñ∂Ô∏è Ejecutando bot en modo single-run..."
          
          ./habitica-bot \
            -api-user "$HABITICA_API_USER" \
            -api-key "$HABITICA_API_KEY" \
            -min-lvl "$MIN_LVL" \
            -language "$LANGUAGE" \
            -only-active "$ONLY_ACTIVE" \
            -fetch-interval "$FETCH_INTERVAL" \
            -single-run true
          
          echo ""
          echo "‚úÖ Ejecuci√≥n completada exitosamente"
          echo "‚è∞ Pr√≥xima ejecuci√≥n autom√°tica: en 10 minutos"
      
      - name: Limpiar binario
        if: always()
        run: |
          echo "üßπ Limpiando binario..."
          rm -f habitica-bot
          echo "‚úÖ Limpieza completada"

  # Job adicional para monitoreo (opcional)
  monitor:
    runs-on: ubuntu-latest
    needs: run-habitica-bot
    if: always()
    steps:
      - name: Reporte de ejecuci√≥n
        run: |
          echo "üìä RESUMEN DE EJECUCI√ìN"
          echo "======================="
          echo "Workflow: ${{ github.workflow }}"
          echo "Ejecuci√≥n: ${{ github.run_id }}"
          echo "Hora: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Estado del job anterior: ${{ needs.run-habitica-bot.result }}"
          
          if [ "${{ needs.run-habitica-bot.result }}" = "success" ]; then
            echo "‚úÖ Bot ejecutado exitosamente"
          else
            echo "‚ö†Ô∏è  Bot encontr√≥ problemas"
          fi
          
          echo ""
          echo "‚è∞ Pr√≥ximas ejecuciones programadas:"
          echo "  - En 10 minutos"
          echo "  - En 20 minutos"
          echo "  - En 30 minutos"
          echo "  - En 40 minutos"
          echo "  - En 50 minutos"